#!/usr/bin/env python
import os
import sys
from cement.core import foundation, hook, handler
import argparse
from pmtools.lib.config import config_defaults
from pmtools import PmController, PmApp, PmOutputHandler
from pmtools.core.project import ProjectController
from pmtools.core.archive import ArchiveController
from pmtools.core.analysis import AnalysisController
from pmtools.core.deliver import DeliveryController

CONFIGFILE=os.path.join(os.getenv("HOME"), ".pm", "pm.conf")

app = PmApp('pm', 
            base_controller=PmController, 
            config_defaults = config_defaults,
            output_handler=PmOutputHandler, 
            config_files=[CONFIGFILE], 
            extensions=['json',
                        'pmtools.ext.ext_hs_metrics']
            )

try:
    handler.register(ProjectController)
    handler.register(ArchiveController)
    handler.register(AnalysisController)
    handler.register(DeliveryController)
    app.setup()
    try:
        app.config.parse_file(CONFIGFILE)
    except:
        app.log.warn("No config file %s; please create and set relevant config sections" % CONFIGFILE)
        sys.exit()

    app.run()
    app.render(app._output_data)

finally:
    app.close()
